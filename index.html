<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Motivo de Contato</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --estoca-blue: #0074d9;
      --estoca-dark-blue: #005fa3;
      --estoca-orange: #ff6600;
      --estoca-bg: #f7f7f7;
      --estoca-white: #fff;
      --estoca-black: #222;
    }

    body {
      font-family: 'Montserrat', Arial, sans-serif;
      background: var(--estoca-bg);
      margin: 0;
      padding: 0;
      color: var(--estoca-black);
    }

    .container {
      max-width: 500px;
      margin: 40px auto;
      background: var(--estoca-white);
      border-radius: 8px;
      box-shadow: 0 2px 8px #0001;
      padding: 32px;
      position: relative;
    }

    h2 {
      margin-top: 0;
      color: var(--estoca-blue);
      font-weight: 700;
      font-size: 1.1rem;
      line-height: 1.2;
      letter-spacing: 0.01em;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li {
      margin-bottom: 12px;
    }

    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 4px;
      background: var(--estoca-orange);
      color: var(--estoca-white);
      font-size: 16px;
      font-family: 'Montserrat', Arial, sans-serif;
      cursor: pointer;
      transition: background 0.2s;
      font-weight: 700;
    }

    button:hover,
    .motivo-btn:hover,
    .enviar-btn:hover {
      background: var(--estoca-blue);
    }

    /* Menu Cards Grid */
    .menu-card-grid {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    .menu-card {
      background: var(--estoca-blue);
      color: var(--estoca-white);
      width: 300px;
      border-radius: 8px;
      padding: 20px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
      display: flex;
      align-items: center;
      gap: 16px;
      transition: background-color 0.3s, transform 0.2s;
      user-select: none;
    }

    .menu-card:hover {
      background: var(--estoca-orange);
      transform: translateY(-3px);
    }

    .menu-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      background: rgba(255 255 255 / 0.2);
      border-radius: 50%;
      flex-shrink: 0;
    }

    .action-title {
      font-weight: 600;
      font-size: 1rem;
    }

    .msg {
      margin-top: 16px;
    }

    .msg.error {
      color: #d00;
      font-weight: 600;
    }

    /* Action Boxes */
    .action-box {
      background: var(--estoca-blue);
      color: var(--estoca-white);
      border-radius: 8px;
      box-shadow: 0 2px 8px #0002;
      padding: 10px 0;
      width: 100%;
      text-align: center;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 8px;
      transition: background 0.2s, transform 0.2s;
      border: none;
      outline: none;
      display: block;
      user-select: none;
    }

    .action-box:hover {
      background: var(--estoca-orange);
      color: var(--estoca-white);
      transform: translateY(-2px) scale(1.02);
    }

    /* Autocomplete lists */
    ul.autocomplete-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 180px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 4px;
      background: #fff;
      position: absolute;
      z-index: 10;
      width: calc(100% - 2px);
      display: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    ul.autocomplete-list li {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    ul.autocomplete-list li:last-child {
      border-bottom: none;
    }

    ul.autocomplete-list li:hover {
      background-color: var(--estoca-orange);
      color: var(--estoca-white);
    }

    /* Input fields and textarea */
    input[type="text"],
    textarea {
      width: 100%;
      margin-bottom: 8px;
      padding: 7px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      font-family: 'Montserrat', Arial, sans-serif;
      box-sizing: border-box;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    /* For relative positioning of autocomplete container */
    .autocomplete-wrapper {
      position: relative;
      width: 100%;
    }

    /* Estilos para campos readonly */
    input[readonly] {
      background-color: #f8f9fa;
      color: #6c757d;
      cursor: not-allowed;
    }

    /* Indicadores de campos obrigat√≥rios */
    .required-field::after {
      content: " *";
      color: var(--estoca-orange);
      font-weight: bold;
    }

    /* Estilo para campos com dados preenchidos automaticamente */
    .auto-filled {
      background-color: #e8f5e8 !important;
      color: #155724 !important;
    }

    /* Estilo para o container do mapa */
    #mapa-container {
      transition: all 0.3s ease;
    }

    #mapa {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
    }
  </style>
</head>
<body>
  <div class="container" id="main-container">
    <h2>Qual a√ß√£o voc√™ quer fazer?</h2>
    <div class="menu-card-grid">
      <div class="menu-card" id="acao1">
        <span class="menu-icon">
          <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Documento com linhas de texto -->
            <path d="M8 6h16v20H8z" stroke="#fff" stroke-width="2" fill="none" rx="2"/>
            <path d="M12 10h8v2H12z" stroke="#fff" stroke-width="2" fill="none"/>
            <path d="M12 14h10v2H12z" stroke="#fff" stroke-width="2" fill="none"/>
            <path d="M12 18h6v2H12z" stroke="#fff" stroke-width="2" fill="none"/>
            <path d="M12 22h8v2H12z" stroke="#fff" stroke-width="2" fill="none"/>
            <!-- Indicador de prioridade -->
            <circle cx="24" cy="10" r="2" fill="#fff"/>
          </svg>
        </span>
        <span class="action-title">Falar sobre um chamado j√° aberto</span>
      </div>
      <div class="menu-card" id="acao2">
        <span class="menu-icon">
          <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Pedido/Ordem -->
            <path d="M6 8h20v16H6z" stroke="#fff" stroke-width="2" fill="none" rx="3"/>
            <path d="M10 12h12v2H10z" stroke="#fff" stroke-width="2" fill="none"/>
            <path d="M10 16h8v2H10z" stroke="#fff" stroke-width="2" fill="none"/>
            <path d="M10 20h10v2H10z" stroke="#fff" stroke-width="2" fill="none"/>
            <path d="M10 24h6v2H10z" stroke="#fff" stroke-width="2" fill="none"/>
            <!-- Tag de prioridade -->
            <rect x="22" y="6" width="8" height="8" rx="4" fill="#fff"/>
            <text x="26" y="11" font-family="Arial" font-size="6" fill="#0074d9" text-anchor="middle">!</text>
          </svg>
        </span>
        <span class="action-title">Solicita√ß√£o sobre um pedido de venda</span>
      </div>
      <div class="menu-card" id="acao3">
        <span class="menu-icon">
          <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Engrenagem -->
            <circle cx="16" cy="16" r="10" stroke="#fff" stroke-width="2" fill="none"/>
            <path d="M16 6v4M16 22v4M26 16h-4M10 16H6" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
            <circle cx="16" cy="16" r="3" fill="#fff"/>
            <!-- Setas circulares -->
            <path d="M8 8l4 4M24 24l-4-4" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
            <path d="M24 8l-4 4M8 24l4-4" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </span>
        <span class="action-title">Demais solicita√ß√µes</span>
      </div>
      <div class="menu-card" id="acao4">
        <span class="menu-icon">
          <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Mapa/Localiza√ß√£o -->
            <path d="M16 4C10.477 4 6 8.477 6 14c0 5 10 14 10 14s10-9 10-14c0-5.523-4.477-10-10-10z" stroke="#fff" stroke-width="2" fill="none"/>
            <circle cx="16" cy="14" r="4" stroke="#fff" stroke-width="2" fill="none"/>
            <circle cx="16" cy="14" r="2" fill="#fff"/>
            <!-- Marcador de posi√ß√£o -->
            <path d="M16 26l-2-2M16 26l2-2" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </span>
        <span class="action-title">Altera√ß√£o de endere√ßo</span>
      </div>
    </div>
    <div id="msg" class="msg"></div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const ticket_id = urlParams.get('ticket_id') || '';
    const conversation_id = urlParams.get('conversation_id') || '';
    const container = document.getElementById('main-container');

    const TICKET_KEY = 'eva_ticket_' + ticket_id;
    if (ticket_id && localStorage.getItem(TICKET_KEY) === 'respondido') {
      container.innerHTML = `<h2 style="color:var(--estoca-orange);">Este ticket j√° foi respondido.<br>N√£o √© poss√≠vel acessar novamente.</h2>`;
    } else {
      document.getElementById('acao1').onclick = abrirFluxo1;
      document.getElementById('acao2').onclick = abrirFluxo2;
      document.getElementById('acao3').onclick = abrirFluxo3;
      document.getElementById('acao4').onclick = abrirFluxo4;
    }

    function validarUUID(uuid) {
      return /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(uuid);
    }

    async function enviarWebhook(payload) {
      try {
        await fetch('https://n8n.estoca.com.br/webhook/resposta_eva_v4', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (payload.ticket_id) {
          localStorage.setItem('eva_ticket_' + payload.ticket_id, 'respondido');
        }
      } catch (e) {
        console.error('Erro ao enviar webhook:', e);
      }
    }

    function abrirFluxo1() {
      container.innerHTML = `
        <h2>Chamado j√° aberto</h2>
        <form id="form1" class="form-box" novalidate>
          <label for="ticketid" style="font-size:0.95rem;">TicketID:</label>
          <input type="text" id="ticketid" name="ticketid" required />
          <label for="solicitacao" style="font-size:0.95rem;">Solicita√ß√£o:</label>
          <textarea id="solicitacao" name="solicitacao" required></textarea>
          <div class="action-box" id="enviar-chamado">Enviar</div>
        </form>
        <div id="msg" class="msg"></div>
      `;

      const enviarBtn = document.getElementById('enviar-chamado');
      const form = document.getElementById('form1');
      const msg = document.getElementById('msg');

      enviarBtn.onclick = async e => {
        e.preventDefault();

        const ticketid = form.ticketid.value.trim();
        const solicitacao = form.solicitacao.value.trim();

        msg.textContent = '';
        msg.className = 'msg';

        if (!ticketid) {
          msg.textContent = 'Preencha o TicketID.';
          msg.classList.add('error');
          return;
        }
        if (!solicitacao) {
          msg.textContent = 'Preencha a solicita√ß√£o.';
          msg.classList.add('error');
          return;
        }

        await enviarWebhook({
          tipo: 'chamado_aberto',
          ticketid,
          solicitacao,
          ticket_id,
          conversation_id,
        });

        container.innerHTML = `<h2>Solicita√ß√£o enviada!</h2><div class="msg">TicketID: ${ticketid}<br>Solicita√ß√£o: ${solicitacao}</div>`;
      };

      form.onsubmit = e => {
        e.preventDefault();
        enviarBtn.click();
      };
    }

    function abrirFluxo2() {
      const motivosPedido = [
        { texto: 'Interrup√ß√£o de entrega (devolu√ß√£o)', label: 'altera√ß√µes_no_pedido__interrup√ß√£o_de_entrega__devolu√ß√£o_' },
        { texto: 'Devolu√ß√£o por insucesso', label: 'devolu√ß√£o__devolu√ß√£o_por_insucesso' },
        { texto: 'C√≥digo de Reversa', label: 'log√≠stica_reversa__c√≥digo_de_reversa' },
        { texto: 'Problema com log√≠stica reversa', label: 'log√≠stica_reversa__problema_com_log√≠stica_reversa' },
        { texto: 'Pedido B2B', label: 'pedido_b2b' },
        { texto: 'Altera√ß√£o/ajuste de SKU', label: 'pedido__altera√ß√£o/ajuste_de_sku' },
        { texto: 'Cancelar/deletar pedido', label: 'pedido__cancelar/deletar_pedido_' },
        { texto: 'Criar/integrar pedido manualmente', label: 'pedido__criar/integrar_pedido_manualmente' },
        { texto: 'D√∫vida sobre status do pedido na plataforma', label: 'pedido__d√∫vida_sobre_status_do_pedido_na_plataforma' },
        { texto: 'Pedido "aguardando libera√ß√£o"', label: 'pedido__pedido__aguardando_libera√ß√£o_' },
        { texto: 'Ressincronizar pedido', label: 'pedido__ressincronizar_pedido' },
        { texto: 'Acarea√ß√£o', label: 'problemas_com_a_entrega__acarea√ß√£o' },
        { texto: 'Comprovante de entrega', label: 'problemas_com_a_entrega__comprovante_de_entrega' },
        { texto: 'O pedido est√° em atraso', label: 'problemas_com_a_entrega__o_pedido_est√°_em_atraso' },
        { texto: 'O pedido est√° retido em posto fiscal (SEFAZ)', label: 'problemas_com_a_entrega__o_pedido_est√°_retido_em_posto_fiscal__sefaz_' },
        { texto: 'O pedido foi avariado', label: 'problemas_com_a_entrega__o_pedido_foi_avariado' },
        { texto: 'O pedido foi extraviado', label: 'problemas_com_a_entrega__o_pedido_foi_extraviado' },
        { texto: 'Pedido entregue com itens faltando/errados (fulfillment)', label: 'problemas_com_a_entrega__pedido_entregue_com_itens_faltando/errados__fulfillment_' },
        { texto: 'Pedido entregue com itens faltando/errados (transportes)', label: 'problemas_com_a_entrega__pedido_entregue_com_itens_faltando/errados__transportes_' },
        { texto: 'Reabertura de Acarea√ß√£o', label: 'problemas_com_a_entrega__reabertura_de_acarea√ß√£o' },
        { texto: 'D√∫vida sobre prazo de entrega', label: 'rastreamento__d√∫vida_sobre_prazo_de_entrega' },
        { texto: 'D√∫vidas sobre o status do rastreamento', label: 'rastreamento__d√∫vidas_sobre_o_status_do_rastreamento' },
        { texto: 'Problemas com Tracking.Estoca', label: 'rastreamento__problemas_com_tracking.estoca' },
        { texto: 'Pedido redespachado via Correios', label: 'redespacho__pedido_redespachado_via_correios' },
        { texto: 'M√° conduta do transportador', label: 'problemas_com_a_entrega__m√°_conduta_do_transportador' }
      ].sort((a, b) => a.texto.localeCompare(b.texto));

      container.innerHTML = `
        <h2>Motivo do pedido de venda:</h2>
        <form id="formPedido" class="form-box" novalidate style="position:relative;">
          <label for="motivo-pedido" style="font-size:0.95rem;">Motivo:</label>
          <div class="autocomplete-wrapper">
            <input type="text" id="motivo-pedido" name="motivo-pedido" autocomplete="off" required placeholder="Digite para buscar..." />
            <ul id="motivo-pedido-list" class="autocomplete-list"></ul>
          </div>
          <label for="orderid" style="font-size:0.95rem;">Pedido (UUID):</label>
          <input type="text" id="orderid" name="orderid" required placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
          <div id="uuid-alert" class="msg error" style="display:none;"></div>
          <label for="descricao" style="font-size:0.95rem;">Descri√ß√£o:</label>
          <textarea id="descricao" name="descricao" required></textarea>
          <div class="action-box" id="enviar-pedido">Enviar</div>
        </form>
        <div id="msg" class="msg"></div>
      `;

      const motivoInput = document.getElementById('motivo-pedido');
      const motivoList = document.getElementById('motivo-pedido-list');
      const uuidInput = document.getElementById('orderid');
      const uuidAlert = document.getElementById('uuid-alert');
      let motivoSelecionado = null;

      motivoInput.addEventListener('input', () => {
        const val = motivoInput.value.toLowerCase();
        motivoList.innerHTML = '';

        if (!val) {
          motivoList.style.display = 'none';
          motivoSelecionado = null;
          return;
        }

        const filtrados = motivosPedido.filter(m => m.texto.toLowerCase().includes(val));

        filtrados.forEach(motivo => {
          const li = document.createElement('li');
          li.textContent = motivo.texto;
          li.onclick = () => {
            motivoInput.value = motivo.texto;
            motivoSelecionado = motivo;
            motivoList.style.display = 'none';
          };
          motivoList.appendChild(li);
        });
        motivoList.style.display = filtrados.length ? 'block' : 'none';
      });

      motivoInput.addEventListener('focus', () => {
        if (motivoInput.value) motivoInput.dispatchEvent(new Event('input'));
      });

      document.addEventListener('click', e => {
        if (!motivoInput.contains(e.target) && !motivoList.contains(e.target)) {
          motivoList.style.display = 'none';
        }
      });

      uuidInput.addEventListener('input', () => {
        if (!validarUUID(uuidInput.value.trim())) {
          uuidAlert.textContent = 'ID do pedido inv√°lido. Deve ser um UUID (36 caracteres, formato XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX).';
          uuidAlert.style.display = 'block';
        } else {
          uuidAlert.textContent = '';
          uuidAlert.style.display = 'none';
        }
      });

      const enviarBtn = document.getElementById('enviar-pedido');
      const form = document.getElementById('formPedido');
      const msg = document.getElementById('msg');

      enviarBtn.onclick = async e => {
        e.preventDefault();

        const orderid = uuidInput.value.trim();
        const descricao = form.descricao.value.trim();
        const motivoAtual = motivoSelecionado || motivosPedido.find(m => m.texto === motivoInput.value.trim());

        msg.textContent = '';
        msg.className = 'msg';

        if (!motivoAtual) {
          msg.textContent = 'Selecione um motivo v√°lido.';
          msg.classList.add('error');
          return;
        }

        if (!validarUUID(orderid)) {
          uuidAlert.textContent = 'ID do pedido inv√°lido. Deve ser um UUID.';
          uuidAlert.style.display = 'block';
          return;
        }

        if (!descricao) {
          msg.textContent = 'Preencha a descri√ß√£o.';
          msg.classList.add('error');
          return;
        }

        await enviarWebhook({
          tipo: 'pedido_venda',
          orderid,
          motivo: motivoAtual.label,
          motivo_texto: motivoAtual.texto,
          descricao,
          ticket_id,
          conversation_id,
        });

        container.innerHTML = `
          <h2>Solicita√ß√£o enviada!</h2>
          <div class="msg">
            Pedido: ${orderid}<br>
            Motivo: ${motivoAtual.texto}<br>
            Descri√ß√£o: ${descricao}
          </div>
        `;
      };

      form.onsubmit = e => {
        e.preventDefault();
        enviarBtn.click();
      };
    }

    function abrirFluxo3() {
      // Mant√©m essa fun√ß√£o igual ao c√≥digo anterior ou ajuste conforme necess√°rio...
      const motivosDiversos = [
        { texto: 'Armazenamento de Inbound atrasado', label: 'inbound__armazenamento_de_inbound_atrasado' },
        { texto: 'Cancelamento de retirada de itens do armaz√©m', label: 'retirada__cancelamento_de_retirada_de_itens_do_armaz√©m' },
        { texto: 'C√≥digo de coleta e devolu√ß√£o Mercado Livre', label: 'retirada__c√≥digo_de_coleta_e_devolu√ß√£o_mercado_livre' },
        { texto: 'Contagem de Invent√°rio', label: 'armazenagem__contagem_de_invent√°rio' },
        { texto: 'Disponibilidade de insumos e embalagens', label: 'armazenagem__disponibilidade_de_insumos_e_embalagens' },
        { texto: 'D√∫vida sobre cobran√ßa na fatura', label: 'fatura__d√∫vida_sobre_cobran√ßa_na_fatura' },
        { texto: 'D√∫vida sobre Cria√ß√£o/Agendamento de Inbound', label: 'inbound__d√∫vida_sobre_cria√ß√£o/agendamento_de_inbound' },
        { texto: 'D√∫vida sobre funcionalidade da Plataforma', label: 'plataforma__d√∫vida_sobre_funcionalidade_da_plataforma' },
        { texto: 'D√∫vida sobre ressarcimento', label: 'fatura__d√∫vida_sobre_ressarcimento' },
        { texto: 'D√∫vida sobre status do Inbound', label: 'inbound__d√∫vida_sobre_status_do_inbound' },
        { texto: 'Erro na Plataforma', label: 'plataforma__erro_na_plataforma' },
        { texto: 'Item avariado no armaz√©m', label: 'armazenagem__item_avariado_no_armaz√©m_' },
        { texto: 'Lentid√£o na Plataforma', label: 'plataforma__lentid√£o_na_plataforma' },
        { texto: 'Problema com Inbound', label: 'inbound__problema_com_inbound' },
        { texto: 'Problemas com Login na Plataforma', label: 'plataforma__problemas_com_login_na_plataforma' },
        { texto: 'Problema com retirada de itens do armaz√©m', label: 'retirada__problema_com_retirada_de_itens_do_armaz√©m' },
        { texto: 'Prioridade no Inbound', label: 'inbound__prioridade_no_inbound' },
        { texto: 'Solicita√ß√£o de customiza√ß√£o', label: 'armazenagem__solicita√ß√£o_de_customiza√ß√£o' },
        { texto: 'Solicita√ß√£o de retirada de itens do armaz√©m', label: 'retirada__solicita√ß√£o_de_retirada_de_itens_do_armaz√©m' },
        { texto: 'Transfer√™ncia de estoque entre armaz√©ns', label: 'retirada__transfer√™ncia_de_estoque_entre_armaz√©ns' }
      ].sort((a,b) => a.texto.localeCompare(b.texto));

      container.innerHTML = `
        <h2>Motivo da solicita√ß√£o:</h2>
        <form id="formDiversos" class="form-box" novalidate style="position:relative;">
          <label for="motivo-diverso" style="font-size:0.95rem;">Motivo:</label>
          <div class="autocomplete-wrapper">
            <input type="text" id="motivo-diverso" name="motivo-diverso" autocomplete="off" required placeholder="Digite para buscar..." />
            <ul id="motivo-diverso-list" class="autocomplete-list"></ul>
          </div>
          <label for="descricao" style="font-size:0.95rem;">Descri√ß√£o:</label>
          <textarea id="descricao" name="descricao" required></textarea>
          <div class="action-box" id="enviar-diversos">Enviar</div>
        </form>
        <div id="msg" class="msg"></div>
      `;

      const motivoInput = document.getElementById('motivo-diverso');
      const motivoList = document.getElementById('motivo-diverso-list');
      let motivoSelecionado = null;

      motivoInput.addEventListener('input', () => {
        const val = motivoInput.value.toLowerCase();
        motivoList.innerHTML = '';

        if (!val) {
          motivoList.style.display = 'none';
          motivoSelecionado = null;
          return;
        }

        const filtrados = motivosDiversos.filter(m =>
          m.texto.toLowerCase().includes(val)
        );

        filtrados.forEach(motivo => {
          const li = document.createElement('li');
          li.textContent = motivo.texto;
          li.onclick = () => {
            motivoInput.value = motivo.texto;
            motivoSelecionado = motivo;
            motivoList.style.display = 'none';
          };
          motivoList.appendChild(li);
        });

        motivoList.style.display = filtrados.length ? 'block' : 'none';
      });

      motivoInput.addEventListener('focus', () => {
        if (motivoInput.value) motivoInput.dispatchEvent(new Event('input'));
      });

      document.addEventListener('click', e => {
        if (!motivoInput.contains(e.target) && !motivoList.contains(e.target)) {
          motivoList.style.display = 'none';
        }
      });

      const enviarBtn = document.getElementById('enviar-diversos');
      const form = document.getElementById('formDiversos');
      const msg = document.getElementById('msg');

      enviarBtn.onclick = async e => {
        e.preventDefault();

        const descricao = form.descricao.value.trim();
        const motivoAtual =
          motivoSelecionado || motivosDiversos.find(m => m.texto === motivoInput.value.trim());

        msg.textContent = '';
        msg.className = 'msg';

        if (!motivoAtual) {
          msg.textContent = 'Selecione um motivo v√°lido.';
          msg.classList.add('error');
          return;
        }

        if (!descricao) {
          msg.textContent = 'Preencha a descri√ß√£o.';
          msg.classList.add('error');
          return;
        }

        await enviarWebhook({
          tipo: 'demais_solicitacoes',
          motivo: motivoAtual.label,
          motivo_texto: motivoAtual.texto,
          descricao,
          ticket_id,
          conversation_id,
        });

        container.innerHTML = `
          <h2>Solicita√ß√£o enviada!</h2>
          <div class="msg">
            Motivo: ${motivoAtual.texto}<br />
            Descri√ß√£o: ${descricao}
          </div>
        `;
      };

      form.onsubmit = e => {
        e.preventDefault();
        enviarBtn.click();
      };
    }

    function abrirFluxo4() {
      container.innerHTML = `
        <h2>Altera√ß√£o de Endere√ßo</h2>
        <div style="background: #e3f2fd; padding: 12px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid var(--estoca-blue);">
          <p style="margin: 0; font-size: 0.9rem; color: #1565c0;">
            <strong>Instru√ß√µes:</strong> Digite o ID do pedido e o novo CEP. Os campos de endere√ßo ser√£o preenchidos automaticamente. 
            N√∫mero e Complemento s√£o obrigat√≥rios - se n√£o houver, digite "s/n" e "n/a" respectivamente.
          </p>
        </div>
        <form id="formEndereco" class="form-box" novalidate>
          <label for="orderid" style="font-size:0.95rem;">ID do Pedido (UUID):</label>
          <input type="text" id="orderid" name="orderid" required placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
          <div id="uuid-alert" class="msg error" style="display:none;"></div>
          
          <label for="cep" style="font-size:0.95rem;">Novo CEP:</label>
          <input type="text" id="cep" name="cep" required placeholder="00000-000" maxlength="8" />
          <div id="cep-alert" class="msg error" style="display:none;"></div>
          
          <!-- Link discreto para Google Maps -->
          <div id="mapa-container" style="display:none; margin: 15px 0; text-align: center;">
            <a id="link-maps" href="#" target="_blank" style="
              display: inline-block;
              padding: 8px 16px;
              background: transparent;
              color: var(--estoca-blue);
              text-decoration: none;
              border: 1px solid var(--estoca-blue);
              border-radius: 4px;
              font-size: 13px;
              font-weight: 500;
              transition: all 0.2s ease;
            " onmouseover="this.style.background='var(--estoca-blue)'; this.style.color='white'" 
               onmouseout="this.style.background='transparent'; this.style.color='var(--estoca-blue)'">
              üó∫Ô∏è Ver no Google Maps
            </a>
          </div>
          
          <label for="logradouro" style="font-size:0.95rem;">Rua:</label>
          <input type="text" id="logradouro" name="logradouro" required readonly />
          
          <label for="numero" class="required-field" style="font-size:0.95rem;">N√∫mero</label>
          <input type="text" id="numero" name="numero" required placeholder="Se n√£o houver, digite: s/n" />
          
          <label for="complemento" class="required-field" style="font-size:0.95rem;">Complemento</label>
          <input type="text" id="complemento" name="complemento" required placeholder="Se n√£o houver, digite: n/a" />
          
          <label for="bairro" style="font-size:0.95rem;">Bairro:</label>
          <input type="text" id="bairro" name="bairro" required readonly />
          
          <label for="cidade" style="font-size:0.95rem;">Cidade:</label>
          <input type="text" id="cidade" name="cidade" required readonly />
          
          <label for="estado" style="font-size:0.95rem;">UF:</label>
          <input type="text" id="estado" name="estado" required readonly />
          
          <div class="action-box" id="enviar-endereco">Enviar</div>
        </form>
        <div id="msg" class="msg"></div>
      `;

      const orderidInput = document.getElementById('orderid');
      const uuidAlert = document.getElementById('uuid-alert');
      const cepInput = document.getElementById('cep');
      const cepAlert = document.getElementById('cep-alert');
      const logradouroInput = document.getElementById('logradouro');
      const numeroInput = document.getElementById('numero');
      const complementoInput = document.getElementById('complemento');
      const bairroInput = document.getElementById('bairro');
      const cidadeInput = document.getElementById('cidade');
      const estadoInput = document.getElementById('estado');
      const enviarBtn = document.getElementById('enviar-endereco');
      const form = document.getElementById('formEndereco');
      const msg = document.getElementById('msg');

      // Valida√ß√£o do UUID
      orderidInput.addEventListener('input', () => {
        if (!validarUUID(orderidInput.value.trim())) {
          uuidAlert.textContent = 'ID do pedido inv√°lido. Deve ser um UUID (36 caracteres, formato XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX).';
          uuidAlert.style.display = 'block';
        } else {
          uuidAlert.textContent = '';
          uuidAlert.style.display = 'none';
        }
      });

      // Busca autom√°tica do CEP
      cepInput.addEventListener('input', async () => {
        const cep = cepInput.value.replace(/\D/g, ''); // Remove caracteres n√£o num√©ricos
        cepInput.value = cep; // Atualiza o campo com apenas n√∫meros
        
        cepAlert.textContent = '';
        cepAlert.style.display = 'none';
        
        // Esconde o mapa quando o usu√°rio come√ßa a digitar
        document.getElementById('mapa-container').style.display = 'none';

        if (cep.length === 8) {
          try {
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await response.json();

            if (data.erro) {
              cepAlert.textContent = 'CEP inv√°lido ou n√£o encontrado.';
              cepAlert.style.display = 'block';
              // Limpa os campos
              logradouroInput.value = '';
              bairroInput.value = '';
              cidadeInput.value = '';
              estadoInput.value = '';
            } else {
              // Preenche automaticamente os campos
              logradouroInput.value = data.logradouro || '';
              bairroInput.value = data.bairro || '';
              cidadeInput.value = data.localidade || '';
              estadoInput.value = data.uf || '';
              
              // Aplica estilo visual aos campos preenchidos
              if (data.logradouro) logradouroInput.classList.add('auto-filled');
              if (data.bairro) bairroInput.classList.add('auto-filled');
              if (data.localidade) cidadeInput.classList.add('auto-filled');
              if (data.uf) estadoInput.classList.add('auto-filled');
              
              // Mostra o mapa com a localiza√ß√£o
              mostrarMapa(data);
              
              // Foca no campo n√∫mero para facilitar o preenchimento
              numeroInput.focus();
            }
          } catch (e) {
            console.error('Erro ao buscar CEP:', e);
            cepAlert.textContent = 'Erro ao buscar CEP. Tente novamente.';
            cepAlert.style.display = 'block';
          }
        }
      });

      enviarBtn.onclick = async e => {
        e.preventDefault();

        const orderid = orderidInput.value.trim();
        const cep = cepInput.value.trim();
        const logradouro = logradouroInput.value.trim();
        const numero = numeroInput.value.trim();
        const complemento = complementoInput.value.trim();
        const bairro = bairroInput.value.trim();
        const cidade = cidadeInput.value.trim();
        const estado = estadoInput.value.trim();

        msg.textContent = '';
        msg.className = 'msg';

        // Valida√ß√µes
        if (!validarUUID(orderid)) {
          uuidAlert.textContent = 'ID do pedido inv√°lido. Deve ser um UUID.';
          uuidAlert.style.display = 'block';
          return;
        }

        if (!cep) {
          cepAlert.textContent = 'Preencha o CEP.';
          cepAlert.style.display = 'block';
          return;
        }

        if (!logradouro) {
          msg.textContent = 'CEP inv√°lido ou n√£o encontrado. Verifique o CEP informado.';
          msg.classList.add('error');
          return;
        }

        if (!numero) {
          msg.textContent = 'Preencha o N√∫mero. Se n√£o houver, digite "s/n".';
          msg.classList.add('error');
          return;
        }

        if (!complemento) {
          msg.textContent = 'Preencha o Complemento. Se n√£o houver, digite "n/a".';
          msg.classList.add('error');
          return;
        }

        if (!bairro) {
          msg.textContent = 'CEP inv√°lido ou n√£o encontrado. Verifique o CEP informado.';
          msg.classList.add('error');
          return;
        }

        if (!cidade) {
          msg.textContent = 'CEP inv√°lido ou n√£o encontrado. Verifique o CEP informado.';
          msg.classList.add('error');
          return;
        }

        if (!estado) {
          msg.textContent = 'CEP inv√°lido ou n√£o encontrado. Verifique o CEP informado.';
          msg.classList.add('error');
          return;
        }

        await enviarWebhook({
          tipo: 'altera√ß√£o_de_endere√ßo',
          orderid,
          cep,
          logradouro,
          numero,
          complemento,
          bairro,
          cidade,
          estado,
          ticket_id,
          conversation_id,
        });

        container.innerHTML = `
          <h2>Altera√ß√£o de Endere√ßo Enviada!</h2>
          <div class="msg">
            <strong>ID do Pedido:</strong> ${orderid}<br>
            <strong>Novo Endere√ßo:</strong><br>
            CEP: ${cep}<br>
            Rua: ${logradouro}<br>
            N√∫mero: ${numero}<br>
            Complemento: ${complemento}<br>
            Bairro: ${bairro}<br>
            Cidade: ${cidade}<br>
            UF: ${estado}
          </div>
        `;
      };

      form.onsubmit = e => {
        e.preventDefault();
        enviarBtn.click();
      };
    }

    // Fun√ß√£o para mostrar apenas o link do Google Maps
    function mostrarMapa(data) {
      const mapaContainer = document.getElementById('mapa-container');
      const linkMaps = document.getElementById('link-maps');
      
      // Mostra o container do link
      mapaContainer.style.display = 'block';
      
      // Monta o endere√ßo completo para o Google Maps
      const enderecoCompleto = `${data.logradouro}, ${data.bairro}, ${data.localidade}, ${data.uf}, ${data.cep}, Brasil`;
      const enderecoEncoded = encodeURIComponent(enderecoCompleto);
      
      // Configura o link do Google Maps
      linkMaps.href = `https://www.google.com/maps/search/${enderecoEncoded}`;
    }
  </script>
</body>
</html>