<script>
    // Configuração inicial e variáveis globais
    const urlParams = new URLSearchParams(window.location.search);
    const ticket_id = urlParams.get('ticket_id') || '';
    const conversation_id = urlParams.get('conversation_id') || '';
    const email_cliente = urlParams.get('email_cliente') || '';
    const container = document.getElementById('main-container');
    const TICKET_KEY = 'eva_ticket_' + ticket_id;

    // Funções de utilidade
    function validarUUID(uuid) {
        return /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(uuid);
    }

    async function enviarWebhook(payload) {
        try {
            await fetch('https://n8n.estoca.com.br/webhook/resposta_eva_v4', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            if (payload.ticket_id) {
                localStorage.setItem('eva_ticket_' + payload.ticket_id, 'respondido');
            }
        } catch (e) {
            console.error('Erro ao enviar webhook:', e);
        }
    }

    async function buscarCEP(cep) {
        try {
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await response.json();
            if (data.erro) {
                throw new Error('CEP não encontrado');
            }
            return data;
        } catch (error) {
            throw new Error('Erro ao buscar CEP');
        }
    }

    // Função para o primeiro fluxo - Chamado já aberto
    function abrirFluxo1() {
        container.innerHTML = `
            <h2>Chamado já aberto</h2>
            <form id="form1" class="form-box" novalidate>
                <label for="ticketid">TicketID:</label>
                <input type="text" id="ticketid" name="ticketid" required />
                
                <label for="email_cliente">Email do cliente:</label>
                <input type="email" id="email_cliente" name="email_cliente" required value="${email_cliente}" />
                
                <label for="solicitacao">Solicitação:</label>
                <textarea id="solicitacao" name="solicitacao" required></textarea>
                
                <div class="action-box" id="enviar-chamado">Enviar</div>
            </form>
            <div id="msg" class="msg"></div>
        `;

        const form = document.getElementById('form1');
        const enviarBtn = document.getElementById('enviar-chamado');
        const msg = document.getElementById('msg');

        enviarBtn.onclick = async (e) => {
            e.preventDefault();
            const ticketid = form.ticketid.value.trim();
            const emailClienteValue = form.email_cliente.value.trim();
            const solicitacao = form.solicitacao.value.trim();

            msg.textContent = '';
            msg.className = 'msg';

            if (!ticketid || !emailClienteValue || !solicitacao) {
                msg.textContent = 'Todos os campos são obrigatórios.';
                msg.classList.add('error');
                return;
            }

            await enviarWebhook({
                tipo: 'chamado_aberto',
                ticketid,
                solicitacao,
                ticket_id,
                conversation_id,
                email_cliente: emailClienteValue,
            });

            container.innerHTML = `
                <h2>Solicitação enviada!</h2>
                <div class="msg">
                    TicketID: ${ticketid}<br>
                    Email: ${emailClienteValue}<br>
                    Solicitação: ${solicitacao}
                </div>
            `;
        };
    }

    // Função para o segundo fluxo - Pedido de venda
    function abrirFluxo2() {
        const motivosPedido = [
            { texto: 'Interrupção de entrega (devolução)', label: 'alterações_no_pedido__interrupção_de_entrega__devolução_' },
            { texto: 'Devolução por insucesso', label: 'devolução__devolução_por_insucesso' },
            { texto: 'Código de Reversa', label: 'logística_reversa__código_de_reversa' },
            { texto: 'Problema com logística reversa', label: 'logística_reversa__problema_com_logística_reversa' },
            { texto: 'Pedido B2B', label: 'pedido_b2b' },
            { texto: 'Alteração/ajuste de SKU', label: 'pedido__alteração/ajuste_de_sku' },
            { texto: 'Cancelar/deletar pedido', label: 'pedido__cancelar/deletar_pedido_' },
            { texto: 'Criar/integrar pedido manualmente', label: 'pedido__criar/integrar_pedido_manualmente' },
            { texto: 'Dúvida sobre status do pedido na plataforma', label: 'pedido__dúvida_sobre_status_do_pedido_na_plataforma' },
            { texto: 'Pedido "aguardando liberação"', label: 'pedido__pedido__aguardando_liberação_' },
            { texto: 'Ressincronizar pedido', label: 'pedido__ressincronizar_pedido' }
        ].sort((a, b) => a.texto.localeCompare(b.texto));

        container.innerHTML = `
            <h2>Motivo do pedido de venda:</h2>
            <form id="formPedido" class="form-box" novalidate>
                <label for="motivo-pedido">Motivo:</label>
                <div class="autocomplete-wrapper">
                    <input type="text" id="motivo-pedido" name="motivo-pedido" required placeholder="Digite para buscar..." />
                    <ul id="motivo-pedido-list" class="autocomplete-list"></ul>
                </div>

                <label for="orderid">Pedido (UUID):</label>
                <input type="text" id="orderid" name="orderid" required placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
                <div id="uuid-alert" class="msg error" style="display:none;"></div>

                <label for="email_cliente">Email do cliente:</label>
                <input type="email" id="email_cliente" name="email_cliente" required value="${email_cliente}" />

                <label for="descricao">Descrição:</label>
                <textarea id="descricao" name="descricao" required></textarea>

                <div class="action-box" id="enviar-pedido">Enviar</div>
            </form>
            <div id="msg" class="msg"></div>
        `;

        const motivoInput = document.getElementById('motivo-pedido');
        const motivoList = document.getElementById('motivo-pedido-list');
        let motivoSelecionado = null;

        motivoInput.addEventListener('input', () => {
            const val = motivoInput.value.toLowerCase();
            motivoList.innerHTML = '';
            
            if (!val) {
                motivoList.style.display = 'none';
                motivoSelecionado = null;
                return;
            }

            const filtrados = motivosPedido.filter(m => m.texto.toLowerCase().includes(val));
            
            filtrados.forEach(motivo => {
                const li = document.createElement('li');
                li.textContent = motivo.texto;
                li.onclick = () => {
                    motivoInput.value = motivo.texto;
                    motivoSelecionado = motivo;
                    motivoList.style.display = 'none';
                };
                motivoList.appendChild(li);
            });

            motivoList.style.display = filtrados.length ? 'block' : 'none';
        });

        const form = document.getElementById('formPedido');
        const enviarBtn = document.getElementById('enviar-pedido');
        
        enviarBtn.onclick = async (e) => {
            e.preventDefault();
            const orderid = form.orderid.value.trim();
            const emailClienteValue = form.email_cliente.value.trim();
            const descricao = form.descricao.value.trim();

            if (!motivoSelecionado || !validarUUID(orderid) || !emailClienteValue || !descricao) {
                alert('Por favor, preencha todos os campos corretamente.');
                return;
            }

            await enviarWebhook({
                tipo: 'pedido_venda',
                orderid,
                motivo: motivoSelecionado.label,
                motivo_texto: motivoSelecionado.texto,
                descricao,
                ticket_id,
                conversation_id,
                email_cliente: emailClienteValue,
            });

            container.innerHTML = `
                <h2>Solicitação enviada!</h2>
                <div class="msg">
                    Pedido: ${orderid}<br>
                    Email: ${emailClienteValue}<br>
                    Motivo: ${motivoSelecionado.texto}<br>
                    Descrição: ${descricao}
                </div>
            `;
        };
    }

    // Função para o terceiro fluxo - Demais solicitações
    function abrirFluxo3() {
        const motivosDiversos = [
            { texto: 'Armazenamento de Inbound atrasado', label: 'inbound__armazenamento_de_inbound_atrasado' },
            { texto: 'Cancelamento de retirada de itens do armazém', label: 'retirada__cancelamento_de_retirada_de_itens_do_armazém' },
            { texto: 'Código de coleta e devolução Mercado Livre', label: 'retirada__código_de_coleta_e_devolução_mercado_livre' },
            { texto: 'Contagem de Inventário', label: 'armazenagem__contagem_de_inventário' },
            { texto: 'Disponibilidade de insumos e embalagens', label: 'armazenagem__disponibilidade_de_insumos_e_embalagens' },
            { texto: 'Dúvida sobre cobrança na fatura', label: 'fatura__dúvida_sobre_cobrança_na_fatura' },
            { texto: 'Dúvida sobre Criação/Agendamento de Inbound', label: 'inbound__dúvida_sobre_criação/agendamento_de_inbound' },
            { texto: 'Dúvida sobre funcionalidade da Plataforma', label: 'plataforma__dúvida_sobre_funcionalidade_da_plataforma' },
            { texto: 'Dúvida sobre ressarcimento', label: 'fatura__dúvida_sobre_ressarcimento' }
        ].sort((a, b) => a.texto.localeCompare(b.texto));

        container.innerHTML = `
            <h2>Motivo da solicitação:</h2>
            <form id="formDiversos" class="form-box" novalidate>
                <label for="motivo-diverso">Motivo:</label>
                <div class="autocomplete-wrapper">
                    <input type="text" id="motivo-diverso" name="motivo-diverso" required placeholder="Digite para buscar..." />
                    <ul id="motivo-diverso-list" class="autocomplete-list"></ul>
                </div>

                <label for="email_cliente">Email do cliente:</label>
                <input type="email" id="email_cliente" name="email_cliente" required value="${email_cliente}" />

                <label for="descricao">Descrição:</label>
                <textarea id="descricao" name="descricao" required></textarea>

                <div class="action-box" id="enviar-diversos">Enviar</div>
            </form>
            <div id="msg" class="msg"></div>
        `;

        const motivoInput = document.getElementById('motivo-diverso');
        const motivoList = document.getElementById('motivo-diverso-list');
        let motivoSelecionado = null;

        motivoInput.addEventListener('input', () => {
            const val = motivoInput.value.toLowerCase();
            motivoList.innerHTML = '';
            
            if (!val) {
                motivoList.style.display = 'none';
                motivoSelecionado = null;
                return;
            }

            const filtrados = motivosDiversos.filter(m => m.texto.toLowerCase().includes(val));
            
            filtrados.forEach(motivo => {
                const li = document.createElement('li');
                li.textContent = motivo.texto;
                li.onclick = () => {
                    motivoInput.value = motivo.texto;
                    motivoSelecionado = motivo;
                    motivoList.style.display = 'none';
                };
                motivoList.appendChild(li);
            });

            motivoList.style.display = filtrados.length ? 'block' : 'none';
        });

        const form = document.getElementById('formDiversos');
        const enviarBtn = document.getElementById('enviar-diversos');
        
        enviarBtn.onclick = async (e) => {
            e.preventDefault();
            const emailClienteValue = form.email_cliente.value.trim();
            const descricao = form.descricao.value.trim();

            if (!motivoSelecionado || !emailClienteValue || !descricao) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            await enviarWebhook({
                tipo: 'demais_solicitacoes',
                motivo: motivoSelecionado.label,
                motivo_texto: motivoSelecionado.texto,
                descricao,
                ticket_id,
                conversation_id,
                email_cliente: emailClienteValue,
            });

            container.innerHTML = `
                <h2>Solicitação enviada!</h2>
                <div class="msg">
                    Email: ${emailClienteValue}<br>
                    Motivo: ${motivoSelecionado.texto}<br>
                    Descrição: ${descricao}
                </div>
            `;
        };
    }

    // Função para alteração de endereço
    function abrirFluxoEndereco() {
        container.innerHTML = `
            <h2>Alteração de Endereço</h2>
            <form id="formEndereco" class="form-box" novalidate>
                <label for="orderid">Pedido (UUID):</label>
                <input type="text" id="orderid" name="orderid" required placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
                <div id="uuid-alert" class="msg error" style="display:none;"></div>

                <label for="email_cliente">Email do cliente:</label>
                <input type="email" id="email_cliente" name="email_cliente" required value="${email_cliente}" />

                <label for="cep">Novo CEP:</label>
                <input type="text" id="cep" name="cep" required maxlength="9" placeholder="00000-000" />

                <label for="cidade">Cidade:
                                  <label for="cidade">Cidade:</label>
                <input type="text" id="cidade" name="cidade" required readonly />

                <label for="bairro">Bairro:</label>
                <input type="text" id="bairro" name="bairro" required readonly />

                <label for="uf">UF:</label>
                <input type="text" id="uf" name="uf" required readonly />

                <label for="numero">Número:</label>
                <input type="text" id="numero" name="numero" required placeholder="Digite o número ou S/N" />

                <label for="complemento">Complemento:</label>
                <input type="text" id="complemento" name="complemento" required placeholder="Digite o complemento ou N/A" />

                <div class="action-box" id="enviar-endereco">Enviar</div>
            </form>
            <div id="msg" class="msg"></div>
        `;

        const form = document.getElementById('formEndereco');
        const cepInput = document.getElementById('cep');
        const uuidInput = document.getElementById('orderid');
        const msg = document.getElementById('msg');

        // Máscara para CEP
        cepInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.slice(0, 5) + '-' + value.slice(5);
            }
            e.target.value = value;
        });

        // Busca CEP quando perder o foco
        cepInput.addEventListener('blur', async () => {
            const cep = cepInput.value.replace(/\D/g, '');
            if (cep.length === 8) {
                try {
                    const data = await buscarCEP(cep);
                    document.getElementById('cidade').value = data.localidade;
                    document.getElementById('bairro').value = data.bairro;
                    document.getElementById('uf').value = data.uf;
                } catch (error) {
                    alert(error.message);
                }
            }
        });

        // Validação de UUID
        uuidInput.addEventListener('input', () => {
            const uuidAlert = document.getElementById('uuid-alert');
            if (!validarUUID(uuidInput.value.trim())) {
                uuidAlert.textContent = 'ID do pedido inválido. Deve ser um UUID (36 caracteres).';
                uuidAlert.style.display = 'block';
            } else {
                uuidAlert.style.display = 'none';
            }
        });

        // Envio do formulário
        document.getElementById('enviar-endereco').onclick = async (e) => {
            e.preventDefault();
            const formData = {
                orderid: form.orderid.value.trim(),
                email_cliente: form.email_cliente.value.trim(),
                cep: form.cep.value.trim(),
                cidade: form.cidade.value.trim(),
                bairro: form.bairro.value.trim(),
                uf: form.uf.value.trim(),
                numero: form.numero.value.trim(),
                complemento: form.complemento.value.trim()
            };

            // Validação dos campos
            if (!validarUUID(formData.orderid)) {
                alert('ID do pedido inválido');
                return;
            }

            if (Object.values(formData).some(value => !value)) {
                alert('Todos os campos são obrigatórios');
                return;
            }

            await enviarWebhook({
                tipo: 'alteracao_endereco',
                ...formData,
                ticket_id,
                conversation_id
            });

            container.innerHTML = `
                <h2>Alteração de endereço enviada!</h2>
                <div class="msg">
                    Pedido: ${formData.orderid}<br>
                    Email: ${formData.email_cliente}<br>
                    Novo endereço: ${formData.cidade} - ${formData.uf}<br>
                    CEP: ${formData.cep}<br>
                    Bairro: ${formData.bairro}<br>
                    Número: ${formData.numero}<br>
                    Complemento: ${formData.complemento}
                </div>
            `;
        };
    }

    // Verificação inicial e atribuição de eventos
    if (ticket_id && localStorage.getItem(TICKET_KEY) === 'respondido') {
        container.innerHTML = `<h2 style="color:var(--estoca-orange);">Este ticket já foi respondido.<br>Não é possível acessar novamente.</h2>`;
    } else {
        // Adicionar event listeners para os cards do menu
        document.getElementById('acao1').addEventListener('click', abrirFluxo1);
        document.getElementById('acao2').addEventListener('click', abrirFluxo2);
        document.getElementById('acao3').addEventListener('click', abrirFluxo3);
        document.getElementById('acao4').addEventListener('click', abrirFluxoEndereco);
    }
</script>