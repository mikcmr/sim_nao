<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Motivo de Contato</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            --estoca-blue: #0074d9;
            --estoca-dark-blue: #005fa3;
            --estoca-orange: #ff6600;
            --estoca-bg: #f7f7f7;
            --estoca-white: #fff;
            --estoca-black: #222;
        }

        body {
            font-family: 'Montserrat', Arial, sans-serif;
            background: var(--estoca-bg);
            margin: 0;
            padding: 0;
            color: var(--estoca-black);
        }

        .container {
            max-width: 500px;
            margin: 40px auto;
            background: var(--estoca-white);
            border-radius: 8px;
            box-shadow: 0 2px 8px #0001;
            padding: 32px;
            position: relative;
        }

        h2 {
            margin-top: 0;
            color: var(--estoca-blue);
            font-weight: 700;
            font-size: 1.1rem;
            line-height: 1.2;
            letter-spacing: 0.01em;
        }

        .menu-card-grid {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .menu-card {
            background: var(--estoca-blue);
            color: var(--estoca-white);
            width: 300px;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: background-color 0.3s, transform 0.2s;
            user-select: none;
        }

        .menu-card:hover {
            background: var(--estoca-orange);
            transform: translateY(-3px);
        }

        .menu-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            flex-shrink: 0;
            padding: 12px;
            box-sizing: border-box;
        }

        .menu-icon svg {
            width: 100%;
            height: 100%;
        }

        .action-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .form-box {
            margin-top: 20px;
        }

        input[type="text"],
        input[type="email"],
        textarea {
            width: 100%;
            margin-bottom: 16px;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--estoca-blue);
            font-size: 0.95rem;
            font-family: 'Montserrat', Arial, sans-serif;
            box-sizing: border-box;
            background: var(--estoca-white);
            color: var(--estoca-black);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        textarea:focus {
            border-color: var(--estoca-orange);
            box-shadow: 0 0 0 2px rgba(255, 102, 0, 0.2);
            outline: none;
        }

        input[readonly] {
            background: var(--estoca-bg);
            cursor: not-allowed;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.95rem;
            color: var(--estoca-black);
            font-weight: 500;
        }

        .action-box {
            background: var(--estoca-orange);
            color: var(--estoca-white);
            border-radius: 8px;
            box-shadow: 0 2px 8px #0002;
            padding: 12px;
            width: 100%;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
            transition: background 0.2s, transform 0.2s;
            border: none;
            outline: none;
            display: block;
            user-select: none;
        }

        .action-box:hover {
            background: var(--estoca-blue);
            transform: translateY(-2px);
        }

        .msg {
            margin-top: 16px;
            padding: 12px;
            border-radius: 4px;
        }

        .msg.error {
            color: #d00;
            background: #fee;
            border: 1px solid #fcc;
        }

        .autocomplete-wrapper {
            position: relative;
            width: 100%;
        }

        .autocomplete-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 180px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            background: #fff;
            position: absolute;
            z-index: 10;
            width: calc(100% - 2px);
            display: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .autocomplete-list li {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .autocomplete-list li:hover {
            background-color: var(--estoca-orange);
            color: var(--estoca-white);
        }
    </style>
</head>

<body>
    <div class="container" id="main-container">
        <h2>Qual ação você quer fazer?</h2>
        <div class="menu-card-grid">
            <!-- Chamado já aberto - Ícone de telefone/atendimento -->
            <div class="menu-card" id="acao1">
                <span class="menu-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 10.999H22C22 5.869 18.127 2 13.001 2V4C17.025 4 20 6.975 20 10.999Z" fill="white"/>
                        <path d="M13 8.999V6.999C11.897 6.999 11 7.897 11 8.999H13Z" fill="white"/>
                        <path d="M16 10.999H18C18 8.092 15.906 6 13 6V8C14.804 8 16 9.195 16 10.999Z" fill="white"/>
                        <path d="M17.5 21H6.5C5.119 21 4 19.881 4 18.5V5.5C4 4.119 5.119 3 6.5 3H17.5C18.881 3 20 4.119 20 5.5V18.5C20 19.881 18.881 21 17.5 21Z" stroke="white" stroke-width="2"/>
                        <path d="M12 17H12.01" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </span>
                <span class="action-title">Falar sobre um chamado já aberto</span>
            </div>

            <!-- Pedido de venda - Ícone de caixa/logística -->
            <div class="menu-card" id="acao2">
                <span class="menu-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 14L12 19L3 14M21 10L12 15L3 10L12 5L21 10Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M3 14L12 19L21 14" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </span>
                <span class="action-title">Solicitação sobre um pedido de venda</span>
            </div>

            <!-- Demais solicitações - Ícone genérico de documento -->
            <div class="menu-card" id="acao3">
                <span class="menu-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15" stroke="white" stroke-width="2" stroke-linecap="round"/>
                        <path d="M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5C15 6.10457 14.1046 7 13 7H11C9.89543 7 9 6.10457 9 5Z" stroke="white" stroke-width="2"/>
                    </svg>
                </span>
                <span class="action-title">Demais solicitações</span>
            </div>

            <!-- Alteração de endereço - Ícone de localização/mapa -->
            <div class="menu-card" id="acao4">
                <span class="menu-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 13C13.6569 13 15 11.6569 15 10C15 8.34315 13.6569 7 12 7C10.3431 7 9 8.34315 9 10C9 11.6569 10.3431 13 12 13Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 2C7.58172 2 4 5.58172 4 10C4 11.8489 4.8655 14.0023 7.26795 16.7841C9.67041 19.5659 12 22 12 22C12 22 14.3296 19.5659 16.7321 16.7841C19.1345 14.0023 20 11.8489 20 10C20 5.58172 16.4183 2 12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </span>
                <span class="action-title">Alteração de Endereço</span>
            </div>
        </div>
        <div id="msg" class="msg"></div>
    </div>

    <script>
    // Configuração inicial e variáveis globais
    const urlParams = new URLSearchParams(window.location.search);
    const ticket_id = urlParams.get('ticket_id') || '';
    const conversation_id = urlParams.get('conversation_id') || '';
    const email_cliente = urlParams.get('email_cliente') || '';
    const container = document.getElementById('main-container');
    const TICKET_KEY = 'eva_ticket_' + ticket_id;

    // Funções de utilidade
    function validarUUID(uuid) {
        return /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(uuid);
    }

    async function enviarWebhook(payload) {
        try {
            await fetch('https://n8n.estoca.com.br/webhook/resposta_eva_v4', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            if (payload.ticket_id) {
                localStorage.setItem('eva_ticket_' + payload.ticket_id, 'respondido');
            }
        } catch (e) {
            console.error('Erro ao enviar webhook:', e);
        }
    }

    // Função para buscar CEP
    async function buscarCEP(cep) {
        try {
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await response.json();
            if (data.erro) {
                throw new Error('CEP não encontrado');
            }
            return data;
        } catch (error) {
            throw new Error('Erro ao buscar CEP');
        }
    }

    // Funções principais de fluxo
    function abrirFluxo1() {
        container.innerHTML = `
            <h2>Chamado já aberto</h2>
            <form id="form1" class="form-box" novalidate>
                <label for="ticketid">TicketID:</label>
                <input type="text" id="ticketid" name="ticketid" required />
                
                <label for="email_cliente">Email do cliente:</label>
                <input type="email" id="email_cliente" name="email_cliente" required value="${email_cliente}" />
                
                <label for="solicitacao">Solicitação:</label>
                <textarea id="solicitacao" name="solicitacao" required></textarea>
                
                <div class="action-box" id="enviar-chamado">Enviar</div>
            </form>
            <div id="msg" class="msg"></div>
        `;

        const form = document.getElementById('form1');
        const enviarBtn = document.getElementById('enviar-chamado');
        const msg = document.getElementById('msg');

        enviarBtn.onclick = async (e) => {
            e.preventDefault();
            const ticketid = form.ticketid.value.trim();
            const emailClienteValue = form.email_cliente.value.trim();
            const solicitacao = form.solicitacao.value.trim();

            msg.textContent = '';
            msg.className = 'msg';

            if (!ticketid || !emailClienteValue || !solicitacao) {
                msg.textContent = 'Todos os campos são obrigatórios.';
                msg.classList.add('error');
                return;
            }

            await enviarWebhook({
                tipo: 'chamado_aberto',
                ticketid,
                solicitacao,
                ticket_id,
                conversation_id,
                email_cliente: emailClienteValue,
            });

            container.innerHTML = `
                <h2>Solicitação enviada!</h2>
                <div class="msg">
                    TicketID: ${ticketid}<br>
                    Email: ${emailClienteValue}<br>
                    Solicitação: ${solicitacao}
                </div>
            `;
        };
    }

    function abrirFluxoEndereco() {
        container.innerHTML = `
            <h2>Alteração de Endereço</h2>
            <form id="formEndereco" class="form-box" novalidate>
                <label for="orderid">Pedido (UUID):</label>
                <input type="text" id="orderid" name="orderid" required placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
                <div id="uuid-alert" class="msg error" style="display:none;"></div>

                <label for="email_cliente">Email do cliente:</label>
                <input type="email" id="email_cliente" name="email_cliente" required value="${email_cliente}" />

                <label for="cep">Novo CEP:</label>
                <input type="text" id="cep" name="cep" required maxlength="9" placeholder="00000-000" />

                <label for="cidade">Cidade:</label>
                <input type="text" id="cidade" name="cidade" required readonly />

                <label for="bairro">Bairro:</label>
                <input type="text" id="bairro" name="bairro" required readonly />

                <label for="uf">UF:</label>
                <input type="text" id="uf" name="uf" required readonly />

                <label for="numero">Número:</label>
                <input type="text" id="numero" name="numero" required placeholder="Digite o número ou S/N" />

                <label for="complemento">Complemento:</label>
                <input type="text" id="complemento" name="complemento" required placeholder="Digite o complemento ou N/A" />

                <div class="action-box" id="enviar-endereco">Enviar</div>
            </form>
            <div id="msg" class="msg"></div>
        `;

        const form = document.getElementById('formEndereco');
        const cepInput = document.getElementById('cep');
        const uuidInput = document.getElementById('orderid');
        const msg = document.getElementById('msg');

        // Máscara para CEP
        cepInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.slice(0, 5) + '-' + value.slice(5);
            }
            e.target.value = value;
        });

        // Busca CEP quando perder o foco
        cepInput.addEventListener('blur', async () => {
            const cep = cepInput.value.replace(/\D/g, '');
            if (cep.length === 8) {
                try {
                    const data = await buscarCEP(cep);
                    document.getElementById('cidade').value = data.localidade;
                    document.getElementById('bairro').value = data.bairro;
                    document.getElementById('uf').value = data.uf;
                } catch (error) {
                    alert(error.message);
                }
            }
        });

        // Validação de UUID
        uuidInput.addEventListener('input', () => {
            const uuidAlert = document.getElementById('uuid-alert');
            if (!validarUUID(uuidInput.value.trim())) {
                uuidAlert.textContent = 'ID do pedido inválido. Deve ser um UUID (36 caracteres).';
                uuidAlert.style.display = 'block';
            } else {
                uuidAlert.style.display = 'none';
            }
        });

        // Envio do formulário
        document.getElementById('enviar-endereco').onclick = async (e) => {
            e.preventDefault();
            const formData = {
                orderid: form.orderid.value.trim(),
                email_cliente: form.email_cliente.value.trim(),
                cep: form.cep.value.trim(),
                cidade: form.cidade.value.trim(),
                bairro: form.bairro.value.trim(),
                uf: form.uf.value.trim(),
                numero: form.numero.value.trim(),
                complemento: form.complemento.value.trim()
            };

            // Validação dos campos
            if (!validarUUID(formData.orderid)) {
                alert('ID do pedido inválido');
                return;
            }

            if (Object.values(formData).some(value => !value)) {
                alert('Todos os campos são obrigatórios');
                return;
            }

            await enviarWebhook({
                tipo: 'alteracao_endereco',
                ...formData,
                ticket_id,
                conversation_id
            });

            container.innerHTML = `
                <h2>Alteração de endereço enviada!</h2>
                <div class="msg">
                    Pedido: ${formData.orderid}<br>
                    Email: ${formData.email_cliente}<br>
                    Novo endereço: ${formData.cidade} - ${formData.uf}<br>
                    CEP: ${formData.cep}<br>
                    Bairro: ${formData.bairro}<br>
                    Número: ${formData.numero}<br>
                    Complemento: ${formData.complemento}
                </div>
            `;
        };
    }

    // Verificação inicial e atribuição de eventos
    if (ticket_id && localStorage.getItem(TICKET_KEY) === 'respondido') {
        container.innerHTML = `<h2 style="color:var(--estoca-orange);">Este ticket já foi respondido.<br>Não é possível acessar novamente.</h2>`;
    } else {
        document.getElementById('acao1').addEventListener('click', abrirFluxo1);
        document.getElementById('acao2').addEventListener('click', abrirFluxo2);
        document.getElementById('acao3').addEventListener('click', abrirFluxo3);
        document.getElementById('acao4').addEventListener('click', abrirFluxoEndereco);
    }
</script>
</body>
</html>